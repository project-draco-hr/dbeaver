{
  try {
    VMProductDescriptor product=new VMProductDescriptor(XMLUtils.parseDocument(productDescriptor));
    VMVersionDescriptor version=product.getVersion(versionNumber);
    if (version == null) {
      throw new BuildException("Version '" + versionNumber + "' definition not found");
    }
    File dir=new File(targetDirectory);
    if (!dir.exists()) {
      if (!dir.mkdirs()) {
        throw new BuildException("Can't create target directory '" + dir.getAbsolutePath() + "'");
      }
    }
    File versionFile=new File(dir,"version.xml");
    FileOutputStream out=new FileOutputStream(versionFile);
    try {
      XMLBuilder versionXML=new XMLBuilder(out,"UTF-8");
      versionXML.setButify(true);
      generateVersionInfo(product,version,versionXML);
      versionXML.flush();
    }
  finally {
      IOUtils.close(out);
    }
  }
 catch (  IOException e) {
    throw new BuildException("IO error",e);
  }
catch (  XMLException e) {
    throw new BuildException("XML error",e);
  }
}
