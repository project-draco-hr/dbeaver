{
  String pkTableCatalog=JDBCUtils.safeGetStringTrimmed(dbResult,JDBCConstants.PKTABLE_CAT);
  String pkTableSchema=JDBCUtils.safeGetStringTrimmed(dbResult,JDBCConstants.PKTABLE_SCHEM);
  String pkTableName=JDBCUtils.safeGetStringTrimmed(dbResult,JDBCConstants.PKTABLE_NAME);
  int keySeq=JDBCUtils.safeGetInt(dbResult,JDBCConstants.KEY_SEQ);
  int updateRuleNum=JDBCUtils.safeGetInt(dbResult,JDBCConstants.UPDATE_RULE);
  int deleteRuleNum=JDBCUtils.safeGetInt(dbResult,JDBCConstants.DELETE_RULE);
  String pkName=JDBCUtils.safeGetStringTrimmed(dbResult,JDBCConstants.PK_NAME);
  int defferabilityNum=JDBCUtils.safeGetInt(dbResult,JDBCConstants.DEFERRABILITY);
  DBSForeignKeyModifyRule deleteRule=JDBCUtils.getCascadeFromNum(deleteRuleNum);
  DBSForeignKeyModifyRule updateRule=JDBCUtils.getCascadeFromNum(updateRuleNum);
  DBSForeignKeyDefferability defferability;
switch (defferabilityNum) {
case DatabaseMetaData.importedKeyInitiallyDeferred:
    defferability=DBSForeignKeyDefferability.INITIALLY_DEFERRED;
  break;
case DatabaseMetaData.importedKeyInitiallyImmediate:
defferability=DBSForeignKeyDefferability.INITIALLY_IMMEDIATE;
break;
case DatabaseMetaData.importedKeyNotDeferrable:
defferability=DBSForeignKeyDefferability.NOT_DEFERRABLE;
break;
default :
defferability=DBSForeignKeyDefferability.UNKNOWN;
break;
}
if (pkTableName == null) {
log.debug("Null PK table name");
return null;
}
GenericTable pkTable=parent.getDataSource().findTable(context.getProgressMonitor(),pkTableCatalog,pkTableSchema,pkTableName);
if (pkTable == null) {
log.warn("Can't find PK table " + pkTableName);
return null;
}
GenericPrimaryKey pk=null;
if (pkName != null) {
pk=DBUtils.findObject(pkTable.getConstraints(context.getProgressMonitor()),pkName);
if (pk == null) {
log.warn("Unique key '" + pkName + "' not found in table "+ pkTable.getFullQualifiedName());
}
}
if (pk == null) {
String pkColumnName=JDBCUtils.safeGetStringTrimmed(dbResult,JDBCConstants.PKCOLUMN_NAME);
GenericTableColumn pkColumn=pkTable.getAttribute(context.getProgressMonitor(),pkColumnName);
if (pkColumn == null) {
log.warn("Can't find PK table " + pkTable.getFullQualifiedName() + " column "+ pkColumnName);
return null;
}
Collection<GenericPrimaryKey> uniqueKeys=pkTable.getConstraints(context.getProgressMonitor());
if (uniqueKeys != null) {
for (GenericPrimaryKey pkConstraint : uniqueKeys) {
if (pkConstraint.getConstraintType().isUnique() && DBUtils.getConstraintColumn(context.getProgressMonitor(),pkConstraint,pkColumn) != null) {
pk=pkConstraint;
break;
}
}
}
if (pk == null) {
log.warn("Could not find unique key for table " + pkTable.getFullQualifiedName() + " column "+ pkColumn.getName());
String pkFullName=pkTable.getFullQualifiedName() + "." + pkName;
pk=pkMap.get(pkFullName);
if (pk == null) {
pk=new GenericPrimaryKey(pkTable,pkName,null,DBSEntityConstraintType.PRIMARY_KEY,true);
pkMap.put(pkFullName,pk);
pk.getTable().addUniqueKey(pk);
}
pk.addColumn(new GenericTableConstraintColumn(pk,pkColumn,keySeq));
}
}
return new GenericTableForeignKey(parent,fkName,null,pk,deleteRule,updateRule,defferability,true);
}
