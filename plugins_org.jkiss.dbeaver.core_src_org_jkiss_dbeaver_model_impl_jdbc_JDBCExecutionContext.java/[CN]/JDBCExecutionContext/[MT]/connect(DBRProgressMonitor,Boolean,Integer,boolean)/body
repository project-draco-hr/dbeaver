{
  if (connection != null) {
    log.error("Reopening not-closed connection");
    close();
  }
  ACTIVE_CONTEXT.set(this);
  try {
    this.connection=dataSource.openConnection(monitor,purpose);
    if (autoCommit != null) {
      try {
        connection.setAutoCommit(autoCommit);
        this.autoCommit=autoCommit;
      }
 catch (      Throwable e) {
        log.warn("Can't set auto-commit state",e);
      }
    }
    if (txnLevel != null) {
      try {
        connection.setTransactionIsolation(txnLevel);
        this.transactionIsolationLevel=txnLevel;
      }
 catch (      Throwable e) {
        log.warn("Can't set transaction isolation level",e);
      }
    }
{
      try {
        this.autoCommit=connection.getAutoCommit();
      }
 catch (      Throwable e) {
        log.warn("Can't check auto-commit state",e);
      }
    }
    QMUtils.getDefaultHandler().handleContextOpen(this,!this.autoCommit);
    dataSource.initializeContextState(monitor,this,!primaryContext || forceActiveObject);
    this.dataSource.allContexts.add(this);
  }
  finally {
    ACTIVE_CONTEXT.remove();
  }
}
