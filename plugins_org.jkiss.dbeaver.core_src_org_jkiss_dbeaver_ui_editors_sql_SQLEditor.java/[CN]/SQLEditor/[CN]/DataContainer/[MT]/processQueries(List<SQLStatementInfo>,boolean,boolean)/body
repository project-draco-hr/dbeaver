{
  if (queries.isEmpty()) {
    return;
  }
  if (curJobRunning.get() > 0) {
    UIUtils.showErrorDialog(getSite().getShell(),CoreMessages.editors_sql_error_cant_execute_query_title,CoreMessages.editors_sql_error_cant_execute_query_message);
    return;
  }
  final boolean isSingleQuery=(queries.size() == 1);
{
    final ITextSelection originalSelection=(ITextSelection)getSelectionProvider().getSelection();
    final SQLQueryJob job=new SQLQueryJob(isSingleQuery ? CoreMessages.editors_sql_job_execute_query : CoreMessages.editors_sql_job_execute_script,SQLEditor.this,queries);
    job.setDataReceiver(viewer.getDataReceiver());
    job.addQueryListener(new ISQLQueryListener(){
      private long lastUIUpdateTime=-1l;
      @Override public void onStartJob(){
        if (!isSingleQuery) {
          UIUtils.runInUI(null,new Runnable(){
            @Override public void run(){
              sashForm.setMaximizedControl(editorControl);
            }
          }
);
        }
      }
      @Override public void onStartQuery(      final SQLStatementInfo query){
        curJobRunning.incrementAndGet();
        final long curTime=System.currentTimeMillis();
        if (lastUIUpdateTime <= 0 || (curTime - lastUIUpdateTime >= SCRIPT_UI_UPDATE_PERIOD)) {
          selectStatementInEditor(query);
          lastUIUpdateTime=System.currentTimeMillis();
        }
      }
      @Override public void onEndQuery(      final SQLQueryResult result){
        curJobRunning.decrementAndGet();
        if (isDisposed()) {
          return;
        }
        if (result.hasError()) {
          selectStatementInEditor(result.getStatement());
        }
        if (isSingleQuery) {
          DBeaverUI.runUIJob("Process SQL query result",new DBRRunnableWithProgress(){
            @Override public void run(            DBRProgressMonitor monitor) throws InvocationTargetException, InterruptedException {
              processQueryResult(result);
            }
          }
);
        }
      }
      private void selectStatementInEditor(      final SQLStatementInfo query){
        DBeaverUI.runUIJob("Select SQL query in editor",new DBRRunnableWithProgress(){
          @Override public void run(          DBRProgressMonitor monitor) throws InvocationTargetException, InterruptedException {
            selectAndReveal(query.getOffset(),query.getLength());
            setStatus(query.getQuery(),false);
          }
        }
);
      }
      private void processQueryResult(      SQLQueryResult result){
        if (result.hasError()) {
          setStatus(result.getError().getMessage(),true);
        }
        if (queries.size() < 2) {
          getSelectionProvider().setSelection(originalSelection);
        }
        if (!tabItem.isDisposed()) {
          tabItem.setToolTipText(result.getStatement().getQuery());
          if (!CommonUtils.isEmpty(result.getSourceEntity())) {
            tabItem.setText(result.getSourceEntity());
          }
 else {
            int tabIndex=getTabIndex(tabItem);
            tabItem.setText(CoreMessages.editors_sql_data_grid + (tabIndex == 0 ? "" : " [" + (tabIndex + 1) + "]"));
          }
        }
        if (result.getQueryTime() > DBeaverCore.getGlobalPreferenceStore().getLong(PrefConstants.AGENT_LONG_OPERATION_TIMEOUT) * 1000) {
          DBeaverUI.notifyAgent("Query completed [" + getEditorInput().getPath().lastSegment() + "]"+ ContentUtils.getDefaultLineSeparator()+ CommonUtils.truncateString(result.getStatement().getQuery(),200),!result.hasError() ? IStatus.INFO : IStatus.ERROR);
        }
      }
      @Override public void onEndJob(      final boolean hasErrors){
        if (isDisposed()) {
          return;
        }
        UIUtils.runInUI(null,new Runnable(){
          @Override public void run(){
            if (!hasErrors && queries.size() > 1) {
              getSelectionProvider().setSelection(originalSelection);
            }
            if (!isSingleQuery) {
              sashForm.setMaximizedControl(null);
            }
            viewer.getModel().setStatistics(job.getStatistics());
            viewer.updateStatusMessage();
          }
        }
);
      }
    }
);
    if (export) {
      curJob=job;
      ActiveWizardDialog dialog=new ActiveWizardDialog(getSite().getWorkbenchWindow(),new DataTransferWizard(new IDataTransferProducer[]{new DatabaseTransferProducer(getDataContainer(),null)},null),new StructuredSelection(this));
      dialog.open();
    }
 else     if (isSingleQuery) {
      closeJob();
      curJob=job;
      viewer.resetDataFilter(false);
      viewer.refresh();
    }
 else {
      if (fetchResults) {
        job.setFetchResultSets(true);
      }
      job.schedule();
    }
  }
}
