{
  if (queries.isEmpty()) {
    return;
  }
  if (curJobRunning > 0) {
    UIUtils.showErrorDialog(getSite().getShell(),CoreMessages.editors_sql_error_cant_execute_query_title,CoreMessages.editors_sql_error_cant_execute_query_message);
    return;
  }
  try {
    checkSession();
  }
 catch (  DBException ex) {
    this.setStatus(ex.getMessage(),true);
    UIUtils.showErrorDialog(getSite().getShell(),CoreMessages.editors_sql_error_cant_obtain_session,ex.getMessage());
    return;
  }
  if (newTab) {
    createResultSetViewer();
  }
  if (!(resultTabs.getSelection().getData() instanceof ResultSetViewer)) {
    resultTabs.setSelection(0);
  }
  final CTabItem curTab=resultTabs.getSelection();
  final ResultSetViewer resultsView=getResultSetViewer();
{
    final ITextSelection originalSelection=(ITextSelection)getSelectionProvider().getSelection();
    final boolean isSingleQuery=(queries.size() == 1);
    final SQLQueryJob job=new SQLQueryJob(isSingleQuery ? CoreMessages.editors_sql_job_execute_query : CoreMessages.editors_sql_job_execute_script,this,queries,resultsView.getDataReceiver());
    job.addQueryListener(new ISQLQueryListener(){
      private long lastUIUpdateTime=-1l;
      @Override public void onStartJob(){
        if (!isSingleQuery) {
          UIUtils.runInUI(null,new Runnable(){
            @Override public void run(){
              sashForm.setMaximizedControl(editorControl);
            }
          }
);
        }
      }
      @Override public void onStartQuery(      final SQLStatementInfo query){
        curJobRunning++;
        final long curTime=System.currentTimeMillis();
        if (lastUIUpdateTime <= 0 || (curTime - lastUIUpdateTime >= SCRIPT_UI_UPDATE_PERIOD)) {
          selectStatementInEditor(query);
          lastUIUpdateTime=System.currentTimeMillis();
        }
      }
      @Override public void onEndQuery(      final SQLQueryResult result){
        curJobRunning--;
        if (isDisposed()) {
          return;
        }
        if (result.hasError()) {
          selectStatementInEditor(result.getStatement());
        }
        if (isSingleQuery) {
          UIUtils.runInUI(null,new Runnable(){
            @Override public void run(){
              processQueryResult(result);
            }
          }
);
        }
      }
      private void selectStatementInEditor(      final SQLStatementInfo query){
        UIUtils.runInUI(null,new Runnable(){
          @Override public void run(){
            selectAndReveal(query.getOffset(),query.getLength());
            setStatus(query.getQuery(),false);
          }
        }
);
      }
      private void processQueryResult(      SQLQueryResult result){
        if (result.hasError()) {
          setStatus(result.getError().getMessage(),true);
        }
        if (queries.size() < 2) {
          getSelectionProvider().setSelection(originalSelection);
        }
        curTab.setToolTipText(result.getStatement().getQuery());
        if (!CommonUtils.isEmpty(result.getSourceEntity())) {
          curTab.setText(result.getSourceEntity());
        }
 else {
          int tabIndex=getTabIndex(curTab);
          curTab.setText(CoreMessages.editors_sql_data_grid + (tabIndex == 0 ? "" : " [" + (tabIndex + 1) + "]"));
        }
        if (result.getQueryTime() > DBeaverCore.getGlobalPreferenceStore().getLong(PrefConstants.AGENT_LONG_OPERATION_TIMEOUT) * 1000) {
          DBeaverUI.notifyAgent("Query completed [" + getEditorInput().getPath().lastSegment() + "]"+ ContentUtils.getDefaultLineSeparator()+ CommonUtils.truncateString(result.getStatement().getQuery(),200),!result.hasError() ? IStatus.INFO : IStatus.ERROR);
        }
      }
      @Override public void onEndJob(      final boolean hasErrors){
        if (isDisposed()) {
          return;
        }
        UIUtils.runInUI(null,new Runnable(){
          @Override public void run(){
            if (!hasErrors && queries.size() > 1) {
              getSelectionProvider().setSelection(originalSelection);
            }
            if (!isSingleQuery) {
              sashForm.setMaximizedControl(null);
            }
          }
        }
);
      }
    }
);
    if (isSingleQuery) {
      closeJob();
      curJob=job;
      if (export) {
        ActiveWizardDialog dialog=new ActiveWizardDialog(getSite().getWorkbenchWindow(),new DataTransferWizard(new IDataTransferProducer[]{new DatabaseTransferProducer(getDataContainer(),null)},null),new StructuredSelection(this));
        dialog.open();
      }
 else {
        resultsView.setDataFilter(new DBDDataFilter(),false);
        resultsView.refresh();
      }
    }
 else {
      job.schedule();
    }
  }
}
