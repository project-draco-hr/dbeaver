{
  if (ownerMonitor != null) {
    monitor=ownerMonitor;
  }
  monitor.beginTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_start,3);
  Thread.currentThread().setName(CoreMessages.dialog_connection_wizard_start_connection_monitor_thread);
  try {
    testDataSource.setName(testDataSource.getConnectionConfiguration().getUrl());
    monitor.worked(1);
    startTime=System.currentTimeMillis();
    testDataSource.connect(monitor,initOnTest,false);
    connectTime=(System.currentTimeMillis() - startTime);
    monitor.worked(1);
    DBPDataSource dataSource=testDataSource.getDataSource();
    if (dataSource == null) {
      throw new DBException(CoreMessages.editors_sql_status_not_connected_to_database);
    }
    monitor.subTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_subtask_test);
    DBPDataSourceInfo info=dataSource.getInfo();
    if (info != null) {
      try {
        productName=info.getDatabaseProductName();
        productVersion=info.getDatabaseProductVersion();
        driverName=info.getDriverName();
        driverVersion=info.getDriverVersion();
      }
 catch (      Exception e) {
        log.error("Can't obtain connection metadata",e);
      }
    }
 else {
      DBCSession session=dataSource.getDefaultContext(false).openSession(monitor,DBCExecutionPurpose.UTIL,"Test connection");
      try {
        if (session instanceof Connection) {
          try {
            Connection connection=(Connection)session;
            DatabaseMetaData metaData=connection.getMetaData();
            productName=metaData.getDatabaseProductName();
            productVersion=metaData.getDatabaseProductVersion();
            driverName=metaData.getDriverName();
            driverVersion=metaData.getDriverVersion();
          }
 catch (          Exception e) {
            log.error("Can't obtain connection metadata",e);
          }
        }
        try {
          monitor.subTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_close);
          testDataSource.disconnect(monitor,false);
        }
 catch (        DBException e) {
          log.error(e);
        }
 finally {
          monitor.done();
        }
      }
  finally {
        session.close();
      }
    }
    monitor.subTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_success);
  }
 catch (  DBException ex) {
    error=ex;
  }
  return Status.OK_STATUS;
}
