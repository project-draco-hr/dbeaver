{
  monitor.beginTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_start,3);
  Thread.currentThread().setName(CoreMessages.dialog_connection_wizard_start_connection_monitor_thread);
  DriverDescriptor driver=getSelectedDriver();
  DBPDataSourceProvider provider;
  try {
    provider=driver.getDataSourceProvider();
  }
 catch (  DBException ex) {
    throw new InvocationTargetException(ex);
  }
  DataSourceDescriptor container=new DataSourceDescriptor(dataSourceRegistry,"test",driver,connectionInfo);
  try {
    container.setName(connectionInfo.getUrl());
    monitor.worked(1);
    container.connect(monitor,false,false);
    monitor.worked(1);
    DBPDataSource dataSource=container.getDataSource();
    if (dataSource == null) {
      throw new InvocationTargetException(new DBException("Internal error: null datasource returned from provider " + provider));
    }
 else {
      monitor.subTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_subtask_test);
      if (dataSource instanceof JDBCDataSource) {
        try {
          Connection connection=((JDBCDataSource)dataSource).getConnection().getConnection();
          DatabaseMetaData metaData=connection.getMetaData();
          productName=metaData.getDatabaseProductName();
          productVersion=metaData.getDatabaseProductVersion();
          driverName=metaData.getDriverName();
          driverVersion=metaData.getDriverVersion();
        }
 catch (        Exception e) {
          log.error("Can't obtain connection metadata",e);
        }
      }
      try {
        monitor.subTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_close);
        container.disconnect(monitor,false);
      }
 catch (      DBException e) {
        log.error(e);
      }
 finally {
        monitor.done();
      }
    }
    monitor.subTask(CoreMessages.dialog_connection_wizard_start_connection_monitor_success);
  }
 catch (  DBException ex) {
    throw new InvocationTargetException(ex);
  }
 finally {
    container.dispose();
  }
}
