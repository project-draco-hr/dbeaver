{
  if (!project.isOpen()) {
    log.warn("Project '" + project.getName() + "' is not open - can't get datasource registry");
    return null;
  }
  String projectId=getProjectId(project);
  DataSourceRegistry dataSourceRegistry=projectId == null ? null : projectDatabases.get(projectId);
  if (dataSourceRegistry == null) {
    throw new IllegalStateException("Project '" + project.getName() + "' not found in registry");
  }
  return dataSourceRegistry;
}
