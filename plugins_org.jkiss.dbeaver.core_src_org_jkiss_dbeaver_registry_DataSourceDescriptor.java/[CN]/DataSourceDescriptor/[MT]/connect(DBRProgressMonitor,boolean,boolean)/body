{
  if (this.isConnected()) {
    return;
  }
  DBPConnectionInfo savedConnectionInfo=null;
  tunnelConnectionInfo=null;
  try {
    this.tunnel=null;
    DBWHandlerConfiguration tunnelConfiguration=null;
    for (    DBWHandlerConfiguration handler : connectionInfo.getDeclaredHandlers()) {
      if (handler.isEnabled() && handler.getType() == DBWHandlerType.TUNNEL) {
        tunnelConfiguration=handler;
        break;
      }
    }
    monitor.beginTask("Connect to " + getName(),tunnelConfiguration != null ? 3 : 2);
    if (tunnelConfiguration != null) {
      monitor.subTask("Initialize tunnel");
      tunnel=tunnelConfiguration.createHandler(DBWTunnel.class);
      try {
        tunnelConnectionInfo=tunnel.initializeTunnel(monitor,tunnelConfiguration,connectionInfo);
      }
 catch (      Exception e) {
        throw new DBCException("Can't initialize tunnel",e);
      }
      monitor.worked(1);
    }
    if (tunnelConnectionInfo != null) {
      savedConnectionInfo=connectionInfo;
      connectionInfo=tunnelConnectionInfo;
    }
    monitor.subTask("Connect to data source");
    dataSource=getDriver().getDataSourceProvider().openDataSource(monitor,this);
    monitor.worked(1);
    if (initialize) {
      monitor.subTask("Initialize data source");
      dataSource.initialize(monitor);
      DBCTransactionManager txnManager=DBUtils.getTransactionManager(dataSource);
      if (txnManager != null) {
        try {
          boolean autoCommit=txnManager.isAutoCommit();
          boolean newAutoCommit;
          if (!preferenceStore.contains(DBeaverPreferences.DEFAULT_AUTO_COMMIT)) {
            newAutoCommit=connectionInfo.getConnectionType().isAutocommit();
          }
 else {
            newAutoCommit=preferenceStore.getBoolean(DBeaverPreferences.DEFAULT_AUTO_COMMIT);
          }
          if (autoCommit != newAutoCommit) {
            txnManager.setAutoCommit(newAutoCommit);
          }
          if (preferenceStore.contains(DBeaverPreferences.DEFAULT_ISOLATION)) {
            int isolationCode=preferenceStore.getInt(DBeaverPreferences.DEFAULT_ISOLATION);
            Collection<DBPTransactionIsolation> supportedLevels=dataSource.getInfo().getSupportedTransactionsIsolation();
            if (!CommonUtils.isEmpty(supportedLevels)) {
              for (              DBPTransactionIsolation level : supportedLevels) {
                if (level.getCode() == isolationCode) {
                  txnManager.setTransactionIsolation(level);
                  break;
                }
              }
            }
          }
          if (dataSource instanceof DBSObjectSelector && dataSource instanceof DBSObjectContainer) {
            String activeObject=getDefaultActiveObject();
            if (!CommonUtils.isEmptyTrimmed(activeObject)) {
              DBSObject child=((DBSObjectContainer)dataSource).getChild(monitor,activeObject);
              if (child != null) {
                try {
                  ((DBSObjectSelector)dataSource).selectObject(monitor,child);
                }
 catch (                DBException e) {
                  log.warn("Can't select active object",e);
                }
              }
 else {
                log.debug("Object '" + activeObject + "' not found");
              }
            }
          }
        }
 catch (        DBCException e) {
          log.error("Can't set session transactions state",e);
        }
 finally {
          monitor.worked(1);
        }
      }
    }
    connectFailed=false;
    connectTime=new Date();
    if (reflect) {
      getRegistry().fireDataSourceEvent(DBPEvent.Action.OBJECT_UPDATE,DataSourceDescriptor.this,true);
    }
    firePropertyChange();
  }
 catch (  Exception e) {
    connectFailed=true;
    getRegistry().fireDataSourceEvent(DBPEvent.Action.OBJECT_UPDATE,DataSourceDescriptor.this,false);
    if (e instanceof DBException) {
      throw (DBException)e;
    }
 else {
      throw new DBException("Internal error connecting to " + getName(),e);
    }
  }
 finally {
    monitor.done();
    if (savedConnectionInfo != null) {
      connectionInfo=savedConnectionInfo;
    }
  }
}
