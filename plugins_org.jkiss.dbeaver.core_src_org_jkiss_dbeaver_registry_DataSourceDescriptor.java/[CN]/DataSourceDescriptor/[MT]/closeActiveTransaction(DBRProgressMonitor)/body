{
  if (dataSource == null) {
    return true;
  }
  monitor.subTask("Rollback active transaction");
  DBCTransactionManager txnManager=DBUtils.getTransactionManager(dataSource);
  try {
    if (txnManager != null && !txnManager.isAutoCommit()) {
      QMMCollector qmm=DBeaverCore.getInstance().getQueryManager().getMetaCollector();
      if (qmm != null) {
        QMMSessionInfo qmmSession=qmm.getSessionInfo(dataSource);
        QMMTransactionInfo txn=qmmSession == null ? null : qmmSession.getTransaction();
        QMMTransactionSavepointInfo sp=txn == null ? null : txn.getCurrentSavepoint();
        if (sp != null && (sp.getPrevious() != null || sp.getLastExecute() != null)) {
          boolean hasUserExec=false;
          if (true) {
            hasUserExec=true;
          }
 else {
            for (QMMTransactionSavepointInfo psp=sp; psp != null; psp=psp.getPrevious()) {
              if (psp.hasUserExecutions()) {
                hasUserExec=true;
                break;
              }
            }
          }
          if (hasUserExec) {
            TransactionCloseConfirmer closeConfirmer=new TransactionCloseConfirmer();
            UIUtils.runInUI(null,closeConfirmer);
            DBCSession session=dataSource.openSession(monitor,DBCExecutionPurpose.UTIL,"End active transaction");
            try {
switch (closeConfirmer.result) {
case IDialogConstants.YES_ID:
                txnManager.commit(session);
              break;
case IDialogConstants.NO_ID:
            txnManager.rollback(session,null);
          break;
default :
        return false;
    }
  }
  finally {
    session.close();
  }
}
}
}
}
}
 catch (Throwable e) {
log.warn("Could not rollback active transaction before disconnect",e);
}
 finally {
monitor.worked(1);
}
return true;
}
