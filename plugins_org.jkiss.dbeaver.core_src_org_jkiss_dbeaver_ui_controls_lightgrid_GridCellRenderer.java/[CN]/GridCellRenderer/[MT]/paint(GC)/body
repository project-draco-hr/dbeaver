{
  boolean drawAsSelected=isSelected();
  boolean drawBackground=true;
  if (isCellSelected()) {
    drawAsSelected=true;
  }
  if (drawAsSelected) {
    Color cellBackground=grid.getCellBackground(cell);
    if (cellBackground.equals(grid.getBackground())) {
      gc.setBackground(colorSelected);
    }
 else {
      RGB cellSel=LightGrid.blend(cellBackground.getRGB(),colorSelected.getRGB(),50);
      gc.setBackground(DBeaverUI.getSharedTextColors().getColor(cellSel));
    }
    gc.setForeground(colorSelectedText);
  }
 else {
    if (grid.isEnabled()) {
      Color back=grid.getCellBackground(cell);
      if (back != null) {
        gc.setBackground(back);
      }
 else {
        drawBackground=false;
      }
    }
 else {
      gc.setBackground(colorBackgroundDisabled);
    }
    gc.setForeground(grid.getCellForeground(cell));
  }
  if (drawBackground)   gc.fillRectangle(bounds.x,bounds.y,bounds.width,bounds.height);
  int x=leftMargin;
  Image image=grid.getCellImage(cell);
  if (image != null) {
    int y=bounds.y;
    y+=(bounds.height - image.getBounds().height) / 2;
    gc.drawImage(image,bounds.x + x,y);
    x+=image.getBounds().width + insideMargin;
  }
  int width=bounds.width - x - rightMargin;
  String text=grid.getCellText(cell);
  if (text != null && !text.isEmpty()) {
    text=TextUtils.getShortString(gc,text,width);
    text=text.replace('\n',UIUtils.PARAGRAPH_CHAR).replace('\r',' ').replace((char)0,' ');
    gc.setFont(grid.getFont());
    gc.drawString(text,bounds.x + x,bounds.y + textTopMargin + topMargin,true);
  }
  if (grid.getLinesVisible()) {
    if (isCellSelected()) {
      gc.setForeground(colorLineForeground);
    }
 else {
      gc.setForeground(grid.getLineColor());
    }
    gc.drawLine(bounds.x,bounds.y + bounds.height,bounds.x + bounds.width - 1,bounds.y + bounds.height);
    gc.drawLine(bounds.x + bounds.width - 1,bounds.y,bounds.x + bounds.width - 1,bounds.y + bounds.height);
  }
  if (isCellFocus()) {
    gc.setForeground(colorLineFocused);
    gc.drawRectangle(bounds.x,bounds.y,bounds.width - 1,bounds.height);
    if (isFocus()) {
      gc.drawRectangle(bounds.x + 1,bounds.y + 1,bounds.width - 3,bounds.height - 2);
    }
  }
}
