{
  closeResultSet();
  curResultSet=resultSet;
  if (curResultSet == null) {
    return;
  }
  DBRProgressMonitor monitor=session.getProgressMonitor();
  monitor.subTask("Fetch result set");
  long rowCount=0;
  String resultsName=null;
{
    DBCResultSetMetaData rsMeta=curResultSet.getResultSetMetaData();
    for (    DBCAttributeMetaData attr : rsMeta.getAttributes()) {
      String entityName=attr.getEntityName();
      if (!CommonUtils.isEmpty(entityName)) {
        if (resultsName == null) {
          resultsName=entityName;
        }
 else         if (!resultsName.equals(entityName)) {
          resultsName=null;
          break;
        }
      }
    }
  }
  DBDDataReceiver dataReceiver=obtainDataReceiver(resultsName,resultsNum);
  dataReceiver.fetchStart(session,curResultSet);
  try {
    long fetchStartTime=System.currentTimeMillis();
    while ((maxRows <= 0 || rowCount < maxRows) && curResultSet.nextRow()) {
      if (monitor.isCanceled()) {
        break;
      }
      rowCount++;
      if (rowCount > 0 && rowCount % 100 == 0) {
        monitor.subTask(rowCount + " rows fetched");
        monitor.worked(100);
      }
      dataReceiver.fetchRow(session,curResultSet);
    }
    if (statistics != null) {
      statistics.setFetchTime(System.currentTimeMillis() - fetchStartTime);
    }
  }
  finally {
    if (!keepResults) {
      closeResultSet();
    }
    try {
      dataReceiver.fetchEnd(session);
    }
 catch (    DBCException e) {
      log.error("Error while handling end of result set fetch",e);
    }
    dataReceiver.close();
  }
  curResult.setRowCount(rowCount);
  if (statistics != null) {
    statistics.setRowsFetched(rowCount);
  }
  monitor.subTask(rowCount + " rows fetched");
}
