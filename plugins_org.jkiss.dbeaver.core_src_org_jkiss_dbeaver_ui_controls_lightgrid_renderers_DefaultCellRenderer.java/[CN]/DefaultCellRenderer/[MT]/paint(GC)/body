{
  boolean drawAsSelected=isSelected();
  boolean drawBackground=true;
  if (isCellSelected()) {
    drawAsSelected=true;
  }
  if (drawAsSelected) {
    gc.setBackground(getDisplay().getSystemColor(SWT.COLOR_LIST_SELECTION));
    gc.setForeground(getDisplay().getSystemColor(SWT.COLOR_LIST_SELECTION_TEXT));
  }
 else {
    if (grid.isEnabled()) {
      Color back=grid.getCellBackground(getColumn(),getRow());
      if (back != null) {
        gc.setBackground(back);
      }
 else {
        drawBackground=false;
      }
    }
 else {
      gc.setBackground(getDisplay().getSystemColor(SWT.COLOR_WIDGET_BACKGROUND));
    }
    gc.setForeground(grid.getCellForeground(getColumn(),getRow()));
  }
  if (drawBackground)   gc.fillRectangle(getBounds().x,getBounds().y,getBounds().width,getBounds().height);
  int x=leftMargin;
  Image image=grid.getCellImage(getColumn(),getRow());
  if (image != null) {
    int y=getBounds().y;
    y+=(getBounds().height - image.getBounds().height) / 2;
    gc.drawImage(image,getBounds().x + x,y);
    x+=image.getBounds().width + insideMargin;
  }
  int width=getBounds().width - x - rightMargin;
  if (drawAsSelected) {
    gc.setForeground(getDisplay().getSystemColor(SWT.COLOR_LIST_SELECTION_TEXT));
  }
 else {
    gc.setForeground(grid.getCellForeground(getColumn(),getRow()));
  }
  String text=grid.getCellText(getColumn(),getRow());
  text=text.replace('\n',UIUtils.PARAGRAPH_CHAR).replace('\r',' ');
  text=TextUtils.getShortString(gc,text,width);
  if (getAlignment() == SWT.RIGHT) {
    int len=gc.stringExtent(text).x;
    if (len < width) {
      x+=width - len;
    }
  }
 else   if (getAlignment() == SWT.CENTER) {
    int len=gc.stringExtent(text).x;
    if (len < width) {
      x+=(width - len) / 2;
    }
  }
  gc.setFont(grid.getFont());
  gc.drawString(text,getBounds().x + x,getBounds().y + textTopMargin + topMargin,true);
  if (grid.getLinesVisible()) {
    if (isCellSelected()) {
      gc.setForeground(getDisplay().getSystemColor(SWT.COLOR_WIDGET_DARK_SHADOW));
    }
 else {
      gc.setForeground(grid.getLineColor());
    }
    gc.drawLine(getBounds().x,getBounds().y + getBounds().height,getBounds().x + getBounds().width - 1,getBounds().y + getBounds().height);
    gc.drawLine(getBounds().x + getBounds().width - 1,getBounds().y,getBounds().x + getBounds().width - 1,getBounds().y + getBounds().height);
  }
  if (isCellFocus()) {
    Rectangle focusRect=new Rectangle(getBounds().x,getBounds().y,getBounds().width - 1,getBounds().height);
    gc.setForeground(getDisplay().getSystemColor(SWT.COLOR_LIST_FOREGROUND));
    gc.drawRectangle(focusRect);
    if (isFocus()) {
      focusRect.x++;
      focusRect.width-=2;
      focusRect.y++;
      focusRect.height-=2;
      gc.drawRectangle(focusRect);
    }
  }
}
