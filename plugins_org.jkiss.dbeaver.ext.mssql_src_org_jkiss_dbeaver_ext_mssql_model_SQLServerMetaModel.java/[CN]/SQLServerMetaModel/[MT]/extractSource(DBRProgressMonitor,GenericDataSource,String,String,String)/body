{
  try (JDBCSession session=DBUtils.openMetaSession(monitor,dataSource,"Read view definition")){
    String activeCatalog=dataSource.getSelectedEntityName();
    boolean switchDatabase=!catalog.equals(activeCatalog);
    if (switchDatabase) {
      try {
        JDBCUtils.executeSQL(session,"USE " + catalog);
      }
 catch (      SQLException e) {
        log.warn("Can't switch to object catalog '" + catalog + "'");
      }
    }
    try {
      try (JDBCPreparedStatement dbStat=session.prepareStatement("sp_helptext '" + schema + "."+ name+ "'")){
        try (JDBCResultSet dbResult=dbStat.executeQuery()){
          StringBuilder sql=new StringBuilder();
          while (dbResult.nextRow()) {
            sql.append(dbResult.getString(1));
          }
          return sql.toString();
        }
       }
     }
  finally {
      if (switchDatabase) {
        try {
          JDBCUtils.executeSQL(session,"USE " + activeCatalog);
        }
 catch (        SQLException e) {
          log.warn("Can't switch back to active catalog '" + activeCatalog + "'");
        }
      }
    }
  }
 catch (  SQLException e) {
    throw new DBException(e,dataSource);
  }
}
