{
  List<Object> rowsExpanded=null;
  for (int i=0; i < rows.length; i++) {
    Object row=rows[i];
    if (rowsExpanded != null) {
      rowsExpanded.add(row);
    }
    Object[] children=contentProvider.getChildren(row);
    if (children != null) {
      IGridContentProvider.ElementState state=contentProvider.getDefaultState(row);
      boolean expanded=state == IGridContentProvider.ElementState.EXPANDED;
      nestedRows.put(row,new NestedRows(children,expanded,level + 1));
      children=collectRows(contentProvider,children,level + 1);
      if (expanded) {
        if (rowsExpanded == null) {
          rowsExpanded=new ArrayList<Object>(rows.length + children.length);
          for (int k=0; k <= i; k++) {
            rowsExpanded.add(rows[k]);
          }
        }
        Collections.addAll(rowsExpanded,children);
      }
    }
  }
  return rowsExpanded == null ? rows : rowsExpanded.toArray();
}
