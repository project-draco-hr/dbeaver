{
  GridPos cell=(GridPos)element;
  Object value;
  DBDValueHandler valueHandler;
  int rowNum;
  int rowCount=model.getRowCount();
  if (mode == ResultSetMode.RECORD) {
    rowNum=curRowNum;
    if (curRowNum >= rowCount || curRowNum < 0) {
      return "";
    }
    Object[] values=model.getRowData(curRowNum);
    if (cell.row >= values.length) {
      log.warn("Bad record row number: " + cell.row);
      return null;
    }
    value=values[cell.row];
    valueHandler=model.getVisibleColumn(cell.row).getValueHandler();
  }
 else {
    rowNum=cell.row;
    if (cell.row >= rowCount) {
      log.warn("Bad grid row number: " + cell.row);
      return null;
    }
    if (cell.col >= model.getVisibleColumnCount()) {
      log.warn("Bad grid column number: " + cell.col);
      return null;
    }
    value=model.getCellValue(cell.row,cell.col);
    valueHandler=model.getVisibleColumn(cell.col).getValueHandler();
  }
  if (rowNum == rowCount - 1 && (mode == ResultSetMode.RECORD || spreadsheet.isRowVisible(rowNum)) && dataReceiver.isHasMoreData()) {
    readNextSegment();
  }
  if (formatString) {
    return valueHandler.getValueDisplayString(model.getVisibleColumn(cell.col).getMetaAttribute(),value,DBDDisplayFormat.UI);
  }
 else {
    return value;
  }
}
