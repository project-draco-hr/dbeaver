{
  int rowNum=curRow == null ? 0 : curRow.getVisualNumber();
  if (rowNum >= model.getRowCount()) {
    rowNum=model.getRowCount() - 1;
  }
  if (rowNum < 0) {
    rowNum=0;
  }
  final DBPDataSource dataSource=getDataSource();
  if (dataSource == null) {
    return;
  }
  final DBDAttributeBinding[] columns=model.getColumns();
  final Object[] cells=new Object[columns.length];
  final int currentRowNumber=rowNum;
  DBCSession session=dataSource.openSession(VoidProgressMonitor.INSTANCE,DBCExecutionPurpose.UTIL,CoreMessages.controls_resultset_viewer_add_new_row_context_name);
  try {
    if (copyCurrent && currentRowNumber >= 0 && currentRowNumber < model.getRowCount()) {
      Object[] origRow=model.getRowData(currentRowNumber);
      for (int i=0; i < columns.length; i++) {
        DBDAttributeBinding metaColumn=columns[i];
        DBSAttributeBase attribute=metaColumn.getAttribute();
        if (attribute.isAutoGenerated() || attribute.isPseudoAttribute()) {
          cells[i]=null;
        }
 else {
          try {
            cells[i]=metaColumn.getValueHandler().getValueFromObject(session,attribute,origRow[i],true);
          }
 catch (          DBCException e) {
            log.warn(e);
            try {
              cells[i]=DBUtils.makeNullValue(session,metaColumn.getValueHandler(),attribute);
            }
 catch (            DBCException e1) {
              log.warn(e1);
            }
          }
        }
      }
    }
 else {
      for (int i=0; i < columns.length; i++) {
        DBDAttributeBinding metaColumn=columns[i];
        try {
          cells[i]=DBUtils.makeNullValue(session,metaColumn.getValueHandler(),metaColumn.getAttribute());
        }
 catch (        DBCException e) {
          log.warn(e);
        }
      }
    }
  }
  finally {
    session.close();
  }
  model.addNewRow(rowNum,cells);
  redrawData(true);
  updateEditControls();
  fireResultSetChange();
}
