{
  GridPos curPos=spreadsheet.getCursorPosition();
  int rowNum;
  if (mode == ResultSetMode.RECORD) {
    rowNum=this.curRowNum;
  }
 else {
    rowNum=curPos.row;
  }
  if (rowNum < 0) {
    rowNum=0;
  }
  model.shiftRows(rowNum,1);
  final Object[] cells=new Object[model.getVisualColumnCount()];
  final int currentRowNumber=rowNum;
  try {
    DBeaverUI.runInProgressService(new DBRRunnableWithProgress(){
      @Override public void run(      DBRProgressMonitor monitor) throws InvocationTargetException, InterruptedException {
        DBCExecutionContext context=getDataSource().openContext(monitor,DBCExecutionPurpose.UTIL,CoreMessages.controls_resultset_viewer_add_new_row_context_name);
        try {
          if (copyCurrent && currentRowNumber >= 0 && currentRowNumber < model.getRowCount()) {
            Object[] origRow=model.getRowData(currentRowNumber);
            for (int i=0; i < model.getVisualColumnCount(); i++) {
              DBDAttributeBinding metaColumn=model.getVisibleColumn(i);
              if (metaColumn.getEntityAttribute().isSequence()) {
                cells[i]=null;
              }
 else {
                try {
                  cells[i]=metaColumn.getValueHandler().getValueFromObject(context,metaColumn.getEntityAttribute(),origRow[i],true);
                }
 catch (                DBCException e) {
                  log.warn(e);
                  try {
                    cells[i]=DBUtils.makeNullValue(context,metaColumn.getValueHandler(),metaColumn.getMetaAttribute());
                  }
 catch (                  DBCException e1) {
                    log.warn(e1);
                  }
                }
              }
            }
          }
 else {
            for (int i=0; i < model.getVisualColumnCount(); i++) {
              DBDAttributeBinding metaColumn=model.getVisibleColumn(i);
              try {
                cells[i]=DBUtils.makeNullValue(context,metaColumn.getValueHandler(),metaColumn.getMetaAttribute());
              }
 catch (              DBCException e) {
                log.warn(e);
              }
            }
          }
        }
  finally {
          context.close();
        }
      }
    }
);
  }
 catch (  InvocationTargetException e) {
    log.error("Could not create new row",e.getTargetException());
  }
catch (  InterruptedException e) {
  }
  model.addNewRow(rowNum,cells);
  refreshSpreadsheet(true);
  updateEditControls();
  fireResultSetChange();
}
