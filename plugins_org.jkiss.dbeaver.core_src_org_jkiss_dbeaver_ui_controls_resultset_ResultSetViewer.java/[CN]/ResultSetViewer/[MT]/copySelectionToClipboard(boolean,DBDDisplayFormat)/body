{
  String lineSeparator=ContentUtils.getDefaultLineSeparator();
  List<Integer> colsSelected=new ArrayList<Integer>();
  int firstCol=Integer.MAX_VALUE, lastCol=Integer.MIN_VALUE;
  int firstRow=Integer.MAX_VALUE;
  Collection<GridPos> selection=spreadsheet.getSelection();
  for (  GridPos pos : selection) {
    if (firstCol > pos.col) {
      firstCol=pos.col;
    }
    if (lastCol < pos.col) {
      lastCol=pos.col;
    }
    if (firstRow > pos.row) {
      firstRow=pos.row;
    }
    if (!colsSelected.contains(pos.col)) {
      colsSelected.add(pos.col);
    }
  }
  StringBuilder tdt=new StringBuilder();
  if (copyHeader) {
    for (    int colIndex : colsSelected) {
      GridColumn column=spreadsheet.getColumn(colIndex);
      if (tdt.length() > 0) {
        tdt.append('\t');
      }
      tdt.append(column.getText());
    }
    tdt.append(lineSeparator);
  }
  int prevRow=firstRow;
  int prevCol=firstCol;
  for (  GridPos pos : selection) {
    if (pos.row > prevRow) {
      if (prevCol < lastCol) {
        for (int i=prevCol; i < lastCol; i++) {
          if (colsSelected.contains(i)) {
            tdt.append('\t');
          }
        }
      }
      tdt.append(lineSeparator);
      prevRow=pos.row;
      prevCol=firstCol;
    }
    if (pos.col > prevCol) {
      for (int i=prevCol; i < pos.col; i++) {
        if (colsSelected.contains(i)) {
          tdt.append('\t');
        }
      }
      prevCol=pos.col;
    }
    GridPos cellPos=translateGridPos(pos);
    Object value=curRows.get(cellPos.row)[cellPos.col];
    String cellText=metaColumns[cellPos.col].getValueHandler().getValueDisplayString(metaColumns[cellPos.col].getAttribute(),value,format);
    if (cellText != null) {
      tdt.append(cellText);
    }
  }
  if (tdt.length() > 0) {
    TextTransfer textTransfer=TextTransfer.getInstance();
    getSpreadsheet().getClipboard().setContents(new Object[]{tdt.toString()},new Transfer[]{textTransfer});
  }
}
