{
  String contextTask=CoreMessages.data_transfer_wizard_job_task_export;
  DBPDataSource dataSource=getSourceObject().getDataSource();
  boolean newConnection=settings.isOpenNewConnections();
  DBCExecutionContext context=newConnection ? dataSource.openIsolatedContext(monitor) : dataSource;
  DBCSession session=context.openSession(monitor,DBCExecutionPurpose.UTIL,contextTask);
  try {
    if (newConnection) {
      session.getTransactionManager().setAutoCommit(false);
    }
    long totalRows=0;
    if (settings.isQueryRowCount() && (dataContainer.getSupportedFeatures() & DBSDataContainer.DATA_COUNT) != 0) {
      monitor.beginTask(CoreMessages.data_transfer_wizard_job_task_retrieve,1);
      try {
        totalRows=dataContainer.countData(session,dataFilter);
      }
 catch (      Throwable e) {
        log.warn("Can't retrieve row count from '" + dataContainer.getName() + "'",e);
      }
 finally {
        monitor.done();
      }
    }
    monitor.beginTask(CoreMessages.data_transfer_wizard_job_task_export_table_data,(int)totalRows);
    try {
      if (settings.getExtractType() == DatabaseProducerSettings.ExtractType.SINGLE_QUERY) {
        dataContainer.readData(session,consumer,dataFilter,-1,-1);
      }
 else {
        long offset=0;
        int segmentSize=settings.getSegmentSize();
        for (; ; ) {
          DBCStatistics statistics=dataContainer.readData(session,consumer,dataFilter,offset,segmentSize);
          if (statistics == null || statistics.getRowsFetched() < segmentSize) {
            break;
          }
          offset+=statistics.getRowsFetched();
        }
      }
    }
  finally {
      monitor.done();
    }
  }
  finally {
    if (newConnection) {
      try {
        session.getTransactionManager().commit();
      }
 catch (      DBCException e) {
        log.error("Can't finish transaction in data producer connection",e);
      }
    }
    session.close();
    if (newConnection) {
      context.close();
    }
  }
}
